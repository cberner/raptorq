<!DOCTYPE html>
<html lang="en-US">
<head>
    <meta charset="utf-8" />
    <title>hello-wasm example</title>
</head>
<body>
<script type="module">
    import init, { Decoder, Encoder, RaptorqFrame } from "../pkg/raptorq.js";
    init().then(() => {
      let test = Array.from({length: 10000}, () => Math.floor(Math.random() * 100));

      let data = Uint8Array.from(test);
      let encoder = Encoder.with_defaults(data, 512);
      let packets = encoder.encode(42);
      console.log(`data ${data} encoded packets are ${packets}`);
      let shuffledPackets = packets.sort((a, b) => 0.5 - Math.random());
      console.log(`data ${data} encoded packets are ${packets}`);


      let decoder = Decoder.with_defaults(BigInt(data.length), 512);

      let decodedData;
      for (let i = 0; i < shuffledPackets.length; i++) {
        console.log(i);
        decodedData = decoder.decode(packets[i]);
        if (decodedData) {
          break;
        }
      }
      console.log(data);
      console.log(decodedData);
      console.log(JSON.stringify(data) === JSON.stringify(decodedData));

      let metadataPart = Uint8Array.from([128,5,89,64,0,0,0,158,99,108,97,114,101,32,97,32,116,105,112,32,118,97,108,117,101,32,102,111,114,32,97,110,32,97,108,114,101,97,100,121,45,111,112,101,110,32,116,105,112,46,0,81,1,84,104,101,32,100,105,115,112,97,116,99,104,32,111,114,105,103,105,110,32,102,111,114,32,116,104,105,115,32,99,97,108,108,32,109,117,115,116,32,98,101,32,95,83,105,103,110,101,100,95,32,97,110,100,32,116,104,101,32,115,105,103,110,105,110,103,32,97,99,99,111,117,110,116,32,109,117,115,116,32,98,101,32,97,112,109,101,109,98,101,114,32,111,102,32,116,104,101,32,96,84,105,112,112,101,114,115,96,32,115,101,116,46,0,97,1,45,32,96,104,97,115,104,96,58,32,84,104,101,32,105,100,101,110,116,105,116,121,32,111,102,32,116,104,101,32,111,112,101,110,32,116,105,112,32,102,111,114,32,119,104,105,99,104,32,97,32,116,105,112,32,118,97,108,117,101,32,105,115,32,100,101,99,108,97,114,101,100,46,32,84,104,105,115,32,105,115,32,102,111,114,109,101,100,93,1,32,32,97,115,32,116,104,101,32,104,97,115,104,32,111,102,32,116,104,101,32,116,117,112,108,101,32,111,102,32,116,104,101,32,104,97,115,104,32,111,102,32,116,104,101,32,111,114,105,103,105,110,97,108,32,116,105,112,32,96,114,101,97,115,111,110,96,32,97,110,100,32,116,104,101,32,98,101,110,101,102,105,99,105,97,114,121,52,32,32,97,99,99,111,117,110,116,32,73,68,46,77,1,45,32,96,116,105,112,95,118,97,108,117,101,96,58,32,84,104,101,32,97,109,111,117,110,116,32,111,102,32,116,105,112,32,116,104,97,116,32,116,104,101,32,115,101,110,100,101,114,32,119,111,117,108,100,32,108,105,107,101,32,116,111,32,103,105,118,101,46,32,84,104,101,32,109,101,100,105,97,110,32,116,105,112,212,32,32,118,97,108,117,101,32,111,102,32,97,99,116,105,118,101,32,116,105,112,112,101,114,115,32,119,105,108,108,32,98,101,32,103,105,118,101,110,32,116,111,32,116,104,101,32,96,119,104,111,96,46,0,97,1,69,109,105,116,115,32,96,84,105,112,67,108,111,115,105,110,103,96,32,105,102,32,116,104,101,32,116,104,114,101,115,104,111,108,100,32,111,102,32,116,105,112,112,101,114,115,32,104,97,115,32,98,101,101,110,32,114,101,97,99,104,101,100,32,97,110,100,32,116,104,101,32,99,111,117,110,116,100,111,119,110,32,112,101,114,105,111,100,48,104,97,115,32,115,116,97,114,116,101,100,46,0,40,35,32,60,119,101,105,103,104,116,62,97,1,45,32,67,111,109,112,108,101,120,105,116,121,58,32,96,79,40,84,41,96,32,119,104,101,114,101,32,96,84,96,32,105,115,32,116,104,101,32,110,117,109,98,101,114,32,111,102,32,116,105,112,112,101,114,115,46,32,100,101,99,111,100,105,110,103,32,96,84,105,112,112,101,114,96,32,118,101,99,32,111,102,32,108,101,110,103,116,104,45,1,32,32,96,84,96,44,32,105,110,115,101,114,116,32,116,105,112,32,97,110,100,32,99,104,101,99,107,32,99,108,111,115,105,110,103,44,32,96,84,96,32,105,115,32,99,104,97,114,103,101,100,32,97,115,32,117,112,112,101,114,32,98,111,117,110,100,32,103,105,118,101,110,32,98,121,93,1,32,32,96,67,111,110,116,97,105,110,115,76,101,110,103,116,104,66,111,117,110,100,96,46,32,84,104,101,32,97,99,116,117,97,108,32,99,111,115,116,32,100,101,112,101,110,100,115,32,111,110,32,116,104,101,32,105,109,112,108,101,109,101,110,116,97,116,105,111,110,32,111,102,32,96,84,58,58,84,105,112,112,101,114,115,96,46,0,93,1,32,32,65,99,116,117,97,108,108,121,32,119,101,105,103,104,116,32,99,111,117,108,100,32,98,101,32,108,111,119,101,114,32,97,115,32,105,116,32,100,101,112,101,110,100,115,32,111,110,32,104,111,119,32,109,97,110,121,32,116,105,112,115,32,97,114,101,32,105,110,32,96,79,112,101,110,84,105,112,96,32,98,117,116,32,105,116,208,32,32,105,115,32,119,101,105,103,104,116,101,100,32,97,115,32,105,102,32,97,108,109,111,115,116,32,102,117,108,108,32,105,46,101,32,111,102,32,108,101,110,103,116,104,32,96,84,45,49,96,46,112,45,32,68,98,82,101,97,100,115,58,32,96,84,105,112,112,101,114,115,96,44,32,96,84,105,112,115,96,72,45,32,68,98,87,114,105,116,101,115,58,32,96,84,105,112,115,96,44,35,32,60,47,119,101,105,103,104,116,62,36,99,108,111,115,101]);
      let raptroqFrame = RaptorqFrame.try_from(metadataPart);
      console.log(`frame  size is ${raptroqFrame.size()}`);
      console.log(`frame total is ${raptroqFrame.total()}`);
      decoder = Decoder.with_defaults(BigInt(raptroqFrame.size()), 1072);
      decoder.decode(raptroqFrame.payload());
    });
</script>
</body>
</html>
